# Worklog — e-ThermoMind

## 2026-02-08
- Normalizzazione config e setpoint con guardie su input e defaults.
- Aggiunte API `/api/entities` GET/POST e validazioni minime payload.
- Reconnect WS Home Assistant con backoff e logging base.
- UI Admin estesa per mapping entità HA.
- Fix encoding in titoli/UI e stringhe logica.
- Aggiornato `PROJECT_LOG.md` con stato e roadmap.
- Aggiunto `build.yaml` per forzare base image `base-python` nel build add-on.
- Avvio server tramite `uvicorn` nel Dockerfile (binding su 0.0.0.0:8099).
- Abilitati `homeassistant_api` e `hassio_api` per ottenere `SUPERVISOR_TOKEN`.
- Lettura fallback del token da `/run/secrets/supervisor_token`.
- Avvio in modalità standalone se il token Supervisor non è disponibile.
- Serviti asset statici Vite da `/assets` per evitare pagina bianca.
- Endpoint debug `/api/assets` per verificare presenza file statici.
- Indicatore Online/Offline HA in UI (User/Admin) con endpoint `/api/status`.
- Supporto token HA da `options.json` con `ha_url`/`ha_token` (fallback se token Supervisor assente).
- Ricerca token Supervisor anche in `s6/container_environment` (compatibilità add-on).
- Mostrata versione add-on in User/Admin via `/api/status`.
- Versione UI ora letta da `config.yaml` (coerente con add-on).
- Polling UI automatico (refresh ogni 3s).
- Polling UI configurabile e timestamp ultimo aggiornamento in UI.
- Logica: isteresi ACS, hold VOLANO->ACS e stato last_* in decision.
- UI: configurazione attuatori + comandi manuali + stato attuatori.
- Logging con timestamp in output add-on.
- Etichette attuatori piu chiare (descrizione funzione).
- Etichetta pompa ACS specificata come PDC -> ACS.
- UI attuatori completa con canali R1-R30 (mapping manuale in Admin).
- Simbolo fisso per attuatori implementati (UI).
- Pallino verde/rosso per gestito/non gestito.
- Fix salvataggio attuatori (salva solo entity_id).
- Indicatore popolato/non popolato per entita e attuatori in Admin.
- Comandi manuali con toggle singolo e stato (icona da HA attributes).
- Toggle colorato per stato e icone MDI reali.
- MDI font locale bundlato via npm (icone HA visibili anche senza CDN).
- Icone toggle colorate per stato e aggiornamento attuatori via polling.
- Selettore runtime mode (dry-run/live) con conferma.
- LIVE resistenze volano con off-delay (R22/R23/R24).
- Log azioni e indicatori runtime mode in UI.
- Icone HA anche per i sensori (Admin + User).
- Admin: etichette e-manager, layout a sezioni, filtro attuatori, export/import config.
- Admin: pulsanti in header + setpoint compatti.
- User: mostra runtime mode e stato resistenze volano (R22/R23/R24).
- Import config anche in header.
- User: nomi completi resistenze + icone colorate per stato.
- Dry-run: log simulato step/export in "Ultime azioni".
- Compatibilita load sensori (stringa -> oggetto UI).
- Blocca refresh mentre si editano i campi (no sparizione input).
- Polling sospeso con focus globale input/select/textarea.
- Polling sospeso in tab Admin (no overwrite mentre si compila).
- Indicatore presenza: pallino rosso fisso + bordo verde se entity presente.
- Rimosso bordo verde; pallino rosso unico a sinistra.
- Indicatori ripristinati: verde = in logica, rosso = non in logica, bordo verde se entity presente.
- Bordo verde input piu evidente (2px + glow).
- Pallino logica spostato accanto all'input entita.
- Pallino logica accanto anche ai sensori.
- Toggle moduli anche in Admin (7 moduli).
- Dry-run: log simulato completo per moduli (stati ON/OFF/DISABLED) + flag volano->puffer.
- Moduli UI: evidenziazione ON con fondo rosso trasparente.
- PROJECT_LOG aggiornato con snapshot 2026-02-09.
- Rimossi comandi manuali, toggle via pallino attuatori + bordo rosso quando ON; user senza pallino.
- Header: pulsanti config uniformati e rimossa duplicazione in sezione Configurazione.
- Guard: se un attuatore ON da HA con modulo attivo, auto-OFF dopo 2s (UI toggle escluso).
- UI User: "Ultime azioni" in ordine inverso (nuove in cima).
- Input attuatori: bordo verde per entita presente + riempimento rosso quando ON.
- Forzato riempimento rosso input ON con !important.
- WebSocket UI: aggiornamento live per User/Admin senza sovrascrivere input in editing.
- Resistenze: aggiunti sensori potenza/energia + switch generale in logica (ON con step).
- Input mapping: blocco overwrite da WS quando campi sono "dirty" finché non salvi.
- WS: applica logica live resistenze durante snapshot (general OFF quando step=0).
- User: aggiunto R0 generale resistenze nella card Resistenze volano.
- User: schema impianto animato con flussi live.
- Resistenze: generale segue step (ON se step>0, OFF se step=0).
- Runtime mode: cambio live/dry-run salvato automaticamente.
